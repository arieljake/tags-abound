
var mongo = require("mongodb");
var userValidate = require('./userValidate');

module.exports.findUserById = function(db,id,callback)
{
	var userId = new mongo.ObjectID(id);

	db.collection("v1_user").find({_id: userId},{limit: 1}).toArray(function (err,items) {
		callback(items[0]);
	});
};

module.exports.findUserByLogin = function (db,login,callback)
{
	db.collection("v1_user").find({username: login.username, password: login.password},{limit: 1}).toArray(function (err,items) {
		callback(items.length === 1 ? items[0] : null);
	});
};

module.exports.createUser = function (db,user,callback)
{
	db.collection("v1_user").find({username: user.username},{username: 1},{limit: 1}).toArray(function (err,items)
	{
		if (items.length === 0)
		{
			db.collection("v1_user").insert(user,function (err,items) {
				callback(true);
			});
		}
		else
		{
			callback("that username is already being used");
		}
	});
};

module.exports.updateUser = function(db,id,user,callback)
{
	var userId = new mongo.ObjectID(id);

	db.collection("v1_user").find({_id: userId}).toArray(function (err,items)
	{
		if (items.length == 1)
		{
			var savedUser = items[0];
			var newUser = userValidate.prepareForUpdate(user,savedUser);

			if (newUser != null)
			{
				db.collection("v1_user").updateById(userId, newUser, function (err,users)
				{
					callback(user);
				});
			}
			else
			{
				callback(null);
			}
		}
	});
};

module.exports.updateUserPassword = function(db,id,user,callback)
{
	var userId = new mongo.ObjectID(id);

	db.collection("v1_user").find({_id: userId}).toArray(function (err,items)
	{
		if (items.length == 1)
		{
			var savedUser = items[0];
			var newUser = userValidate.prepareForUpdatePassword(user,savedUser);

			if (newUser != null)
			{
				db.collection("v1_user").updateById(userId, newUser, function (err,users)
				{
					callback(user);
				});
			}
			else
			{
				callback(null);
			}
		}
	});
};