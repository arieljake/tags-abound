
var listly = require('listly');
var dao = require('listly').userDAO;

exports.init = function (serverParts)
{
	var app = serverParts.app;
	var rewriter = serverParts.rewriter;
	var db = serverParts.db;
	var listlyEmailService = serverParts.listlyEmailService;

	app.get('/login', rewriter.rewrite('/views/login'));
	app.get('/register', registerRedirect);
	app.get('/views/login', index);
	app.get('/views/register', registerRedirect);
	app.get('/views/login/login', login);
	app.get('/views/login/register', register);
	app.post('/doRegister', doRegister(db,listlyEmailService));
	app.post('/doLogin', doLogin(db));
	app.get('/logout', doLogout);
}

var registerRedirect = function (req,res)
{
	res.redirect('/views/login#/register');
};

var index = function(req,res)
{
	res.render('login/index', listly.renderUtils.params(req,{title: "Login", noMenu: true}));
};

var login = function (req,res)
{
	res.render('login/login', listly.renderUtils.params(req,{layout: false}));
};

var register = function (req,res)
{
	res.render('login/register', listly.renderUtils.params(req,{layout: false}));
};

var doLogin = function (db)
{
	return function(req, res)
	{
		var login = {
			username: req.body.username,
			password: req.body.password
		};

		dao.findUserByLogin(db,login,function(user)
		{
			if (user !== null)
			{
				listly.session.createUserSession(user,req);

				res.writeHead(202);
				res.end('login successful');
			}
			else
			{
				res.writeHead(207);
				res.end('login failed, please try again');
			}
		});
	};
};

var doLogout = function(req, res)
{
	listly.session.clearUserSession(req);

	res.redirect('/');
};

var doRegister = function (db,listlyEmailService)
{
	return function (req,res)
	{
		var user = {
			username: req.body.username,
			password: req.body.password
		};

		dao.createUser(db, user, function(user,message)
		{
			if (user !== null)
			{
				listly.session.createUserSession(user,req);
				// listlyEmailService.sendRegistrationEmail(user);

				res.writeHead(202);
				res.end('registration successful');
			}
			else
			{
				res.writeHead(207);
				res.end(message);
			}
		});
	};
};
