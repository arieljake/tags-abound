
var listly = require('listly');

var LoginREST = module.exports.LoginREST = function (listlyServer)
{
	this.userDAO = listlyServer.userDAO;
	this.listlyEmailService = listlyServer.listlyEmailService;

	var app = listlyServer.app;
	app.post('/doLogin', listly.utils.routeHandler(this,this.doLogin));
	app.post('/doRegister', listly.utils.routeHandler(this,this.doRegister));
	app.get('/logout', listly.utils.routeHandler(this,this.doLogout));
};

LoginREST.prototype.doLogin = function(req, res)
{
	var login = {
		username: req.body.username,
		password: req.body.password
	};

	this.userDAO.findUserByLogin(login,function(user)
	{
		if (user !== null)
		{
			listly.session.createUserSession(user,req);

			res.writeHead(202);
			res.end('login successful');
		}
		else
		{
			res.writeHead(207);
			res.end('login failed, please try again');
		}
	});
};

LoginREST.prototype.doLogout = function(req, res)
{
	listly.session.clearUserSession(req);

	res.redirect('/');
};

LoginREST.prototype.doRegister = function (req,res)
{
	var self = this;
	var user = req.body;

	this.userDAO.createUser(user, function(user,message)
	{
		if (user !== null)
		{
			listly.session.createUserSession(user,req);

			if (listly.settings.sendRegistrationEmails)
				self.listlyEmailService.sendRegistrationEmail(user);

			res.writeHead(202);
			res.end('registration successful');
		}
		else
		{
			res.writeHead(207);
			res.end(message);
		}
	});
};