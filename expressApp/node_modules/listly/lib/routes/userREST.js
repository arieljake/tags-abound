
var listly = require('listly');
var underscore = require('underscore');

var UserREST = module.exports.UserREST = function (listlyServer)
{
	this.userDAO = listlyServer.userDAO;

	var app = listlyServer.app;
	app.get('/user', listly.utils.routeHandler(this,this.getCurrentUser));
	app.post('/user', listly.utils.routeHandler(this,this.updateUser));
};

UserREST.prototype.getCurrentUser = function (req,res)
{
	if (req.session === undefined || req.session.username === undefined)
	{
		res.writeHead(404);
	}
	else
	{
		var userId = req.session.userId;

		this.userDAO.findUserById(userId, function(user)
		{
			delete user.password;
			delete user._id;

			res.send(user);
		});
	}
};

UserREST.prototype.updateUser = function (req,res)
{
	var self = this;
	var postValues = req.body;
	var id = req.session.userId;

	if (id !== undefined)
	{
		var user = underscore.clone(postValues);

		this.userDAO.updateUser(id,user,function(user)
		{
			var userPassword = underscore.clone(postValues);

			self.userDAO.updateUserPassword(id,userPassword,function (user)
			{
				res.send(true);
			})
		});
	}
	else
	{
		res.send(false);
	}
};