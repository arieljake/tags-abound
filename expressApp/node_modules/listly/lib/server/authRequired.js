
var listly = require('listly');
var url = require('url');
var json = require('json');

var _enabled = true;
var _registerEnabled = false;

module.exports = function(enabled,registerEnabled,loginDAO)
{
	_enabled = (enabled == undefined) ? _enabled : enabled;
	_registerEnabled = (registerEnabled == undefined) ? _registerEnabled : registerEnabled;

	return function (req,res,next)
	{
		if (!_enabled)
		{
			next();
		}
		else
		{
			var pathname = url.parse(req.url).pathname;

			if (req.method == "GET" && pathname == "/logout")
			{
				listly.session.clearUserSession(req);
				res.redirect('/',302);
			}
			else if (listly.session.isSessionActive(req))
			{
				next();
			}
			else if (req.method == "GET")
			{
				if (pathname.indexOf("/stylesheets") == 0 || pathname.indexOf("/javascripts") == 0 || pathname == "/favicon.ico")
				{
					next();
				}
				else if (pathname.indexOf("/views/login") == 0 || (_registerEnabled && pathname.indexOf("/views/register") == 0))
				{
					next();
				}
				else
				{
					handleInvalidRequest(req,res);
				}
			}
			else if (req.method == "POST")
			{
				if (pathname == "/login" && req.body.username && req.body.password)
				{
					var username = req.body.username;
					var password = req.body.password;

					loginDAO.loginUser(username,password,function (statusCode,data)
					{
						if (statusCode == 202)
						{
							var user = json.parse(data);
							listly.session.createUserSession(user,req);

							res.writeHead(202);
							res.end();
						}
						else
						{
							res.writeHead(statusCode);
							res.send(data);
						}
					});
				}
				else if (pathname == "/register")
				{

				}
				else
				{
					handleInvalidRequest(req,res);
				}
			}
			else
			{
				handleInvalidRequest(req,res);
			}
		}
	};
};

var handleInvalidRequest = function (req,res)
{
	res.redirect('/views/login',302);
};