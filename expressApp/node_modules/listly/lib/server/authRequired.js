
var listly = require('listly');
var url = require('url');
var json = require('json');
var underscore = require('underscore');

var _enabled = true;
var _registerEnabled = false;

module.exports = function(enabled,registerEnabled,loginHandler,registerHandler)
{
	_enabled = (enabled == undefined) ? _enabled : enabled;
	_registerEnabled = (registerEnabled == undefined) ? _registerEnabled : registerEnabled;

	return function (req,res,next)
	{
		if (!_enabled)
		{
			next();
		}
		else
		{
			var pathname = url.parse(req.url).pathname;

			if (req.method == "GET" && pathname == "/logout")
			{
				listly.session.clearUserSession(req);
				res.redirect('/',302);
			}
			else if (listly.session.isSessionActive(req))
			{
				next();
			}
			else if (req.method == "GET")
			{
				if (pathname.indexOf("/stylesheets") == 0 || pathname.indexOf("/javascripts") == 0 || pathname == "/favicon.ico")
				{
					next();
				}
				else if (pathname.indexOf("/views") == 0 && underscore(pathname).endsWith(".js"))
				{
					next();
				}
				else if (pathname.indexOf("/login") == 0 || (_registerEnabled && pathname.indexOf("/register") == 0))
				{
					next();
				}
				else
				{
					handleInvalidRequest(req,res);
				}
			}
			else if (req.method == "POST")
			{
				if (pathname == "/login" && req.body.username && req.body.password)
				{
					loginHandler(req,res);
				}
				else if (pathname == "/register")
				{
					registerHandler(req,res);
				}
				else
				{
					handleInvalidRequest(req,res);
				}
			}
			else
			{
				handleInvalidRequest(req,res);
			}
		}
	};
};

var handleInvalidRequest = function (req,res)
{
	res.redirect('/login',302);
};